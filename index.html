<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IEA Cosmic Core System</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#00e5ff;
  --secondary:#4f7cff;
  --bg:#030616;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Plus Jakarta Sans',sans-serif;
  background:radial-gradient(circle at top,var(--bg),#000);
  color:#fff;
}
h1,h2,h3{
  font-family:'Orbitron',sans-serif;
  letter-spacing:2px;
}
.container{max-width:1300px;margin:auto;padding:50px}
.card{
  background:rgba(255,255,255,.05);
  backdrop-filter:blur(18px);
  border-radius:26px;
  padding:35px;
  margin-bottom:40px;
  box-shadow:0 0 80px rgba(0,229,255,.2);
}
input,textarea{
  width:100%;
  padding:16px;
  margin-top:14px;
  border-radius:16px;
  border:none;
  background:rgba(0,0,0,.7);
  color:var(--primary);
  font-size:15px;
}
button{
  margin-top:22px;
  padding:16px 40px;
  border-radius:60px;
  border:none;
  background:linear-gradient(135deg,var(--secondary),var(--primary));
  color:#000;
  font-weight:800;
  letter-spacing:1px;
  cursor:pointer;
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px}
.stat{font-size:52px;font-weight:800;color:var(--primary)}
table{width:100%;border-collapse:collapse;margin-top:25px}
th,td{padding:14px;border-bottom:1px solid rgba(255,255,255,.12)}
a{color:var(--primary);text-decoration:none}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">

<h1>IEA COSMIC CORE SYSTEM</h1>
<p>Sistem Pendaftaran, Monitoring, dan Analitik Komunitas</p>

<div class="card" id="loginCard">
<h2>Admin Access</h2>
<input id="adminKey" placeholder="Admin Access Key">
<button onclick="loginAdmin()">Masuk</button>
</div>

<div class="card hidden" id="formCard">
<h2>Form Pendaftaran Anggota</h2>
<input id="nama" placeholder="Nama Lengkap">
<input id="lahir" type="date">
<textarea id="tujuan" placeholder="Tujuan masuk komunitas"></textarea>
<input id="tiktok" placeholder="Link TikTok">
<button onclick="daftar()">Kirim Pendaftaran</button>
</div>

<div class="card hidden" id="dashboard">
<h2>Dashboard Admin</h2>
<div class="grid">
  <div class="card"><div>Total Pendaftar</div><div class="stat" id="total">0</div></div>
  <div class="card"><canvas id="chartUsia"></canvas></div>
  <div class="card"><canvas id="chartTujuan"></canvas></div>
</div>

<input id="search" placeholder="Cari nama atau TikTok">

<table>
<thead><tr><th>Nama</th><th>Usia</th><th>Tujuan</th><th>TikTok</th></tr></thead>
<tbody id="list"></tbody>
</table>

<button onclick="exportCSV()">Export CSV</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4lpo6PyADXVVki-bBfcEFf0kxbQuunN8",
  authDomain: "iea-pendaftaran.firebaseapp.com",
  projectId: "iea-pendaftaran",
  storageBucket: "iea-pendaftaran.firebasestorage.app",
  messagingSenderId: "383473027982",
  appId: "1:383473027982:web:679f4c56665f9cb39832df"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_KEY = "IEA-ADMIN-CORE";
window.loginAdmin = () => {
  if(document.getElementById('adminKey').value === ADMIN_KEY){
    loginCard.classList.add('hidden');
    formCard.classList.remove('hidden');
    dashboard.classList.remove('hidden');
  } else alert('Akses ditolak');
};

window.daftar = async () => {
  const nama=nama.value, lahir=lahir.value, tujuan=tujuan.value, tiktok=tiktok.value;
  if(!nama||!lahir||!tiktok) return alert('Lengkapi data');
  const usia=new Date().getFullYear()-new Date(lahir).getFullYear();
  if(usia<15) return alert('Minimal usia 15 tahun');
  await addDoc(collection(db,'pendaftar'),{nama,lahir,tujuan,tiktok,waktu:new Date()});
  alert('Pendaftaran berhasil');
};

let chartUsia, chartTujuan;
const q=query(collection(db,'pendaftar'),orderBy('waktu','desc'));

onSnapshot(q,snap=>{
  total.innerText=snap.size;
  list.innerHTML='';
  let usiaData={}, tujuanData={};
  snap.forEach(doc=>{
    const d=doc.data();
    const usia=new Date().getFullYear()-new Date(d.lahir).getFullYear();
    usiaData[usia]=(usiaData[usia]||0)+1;
    const key=d.tujuan?.split(' ')[0]||'Lainnya';
    tujuanData[key]=(tujuanData[key]||0)+1;
    list.innerHTML+=`<tr><td>${d.nama}</td><td>${usia}</td><td>${d.tujuan||'-'}</td><td><a href="${d.tiktok}" target="_blank">${d.tiktok}</a></td></tr>`;
  });
  if(chartUsia) chartUsia.destroy();
  chartUsia=new Chart(chartUsiaEl,{type:'bar',data:{labels:Object.keys(usiaData),datasets:[{data:Object.values(usiaData)}]},options:{plugins:{legend:{display:false}}}});
  if(chartTujuan) chartTujuan.destroy();
  chartTujuan=new Chart(chartTujuanEl,{type:'pie',data:{labels:Object.keys(tujuanData),datasets:[{data:Object.values(tujuanData)}]}});
});

window.exportCSV = () => {
  let csv='Nama,Usia,Tujuan,TikTok\n';
  document.querySelectorAll('#list tr').forEach(r=>{
    const c=r.children;
    csv+=`${c[0].innerText},${c[1].innerText},"${c[2].innerText}",${c[3].innerText}\n`;
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='pendaftar.csv';
  a.click();
};
</script>
</body>
</html>
